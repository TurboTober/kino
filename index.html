<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Seat Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom screen shape */
        .cinema-screen {
            height: 40px;
            width: 80%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0));
            transform: perspective(200px) rotateX(-5deg);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.1);
            border-radius: 50% 50% 0 0 / 20px 20px 0 0;
            margin: 0 auto 20px auto;
            position: relative;
        }

        .cinema-screen::after {
            content: "SCREEN";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.7rem;
            letter-spacing: 0.2em;
        }

        /* Modal transitions */
        .modal {
            transition: opacity 0.25s ease;
        }

        body.modal-active {
            overflow: hidden;
        }

        /* Custom scrollbar for groups */
        .group-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .group-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 2px;
        }

        .group-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cinema: { 900: '#1a1a2e', 800: '#16213e', 700: '#0f3460', 500: '#e94560' }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-900 text-white min-h-screen font-sans antialiased flex flex-col">

    <!-- Header -->
    <header class="p-4 bg-gray-800 shadow-lg sticky top-0 z-20 flex justify-between items-center h-16">
        <div class="flex items-center gap-3">
            <button id="backBtn" class="hidden text-gray-400 hover:text-white transition">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <h1 class="text-xl font-bold flex items-center gap-2 select-none" id="appTitle">
                <i class="fas fa-film text-red-500"></i>
                <span>Cinema<span class="text-red-500">Mgr</span></span>
            </h1>
        </div>
        <div class="flex gap-2">
            <button id="shareBtn"
                class="hidden bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-full text-sm font-semibold transition flex items-center gap-2 shadow-md">
                <i class="fas fa-share-nodes"></i> <span class="hidden sm:inline">Share</span>
            </button>
            <button id="createCinemaBtn"
                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-full text-sm font-semibold transition flex items-center gap-2 shadow-md">
                <i class="fas fa-plus"></i> <span class="hidden sm:inline">New Cinema</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 flex flex-col h-[calc(100vh-4rem)]">

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="w-full max-w-2xl mx-auto flex flex-col gap-4">
            <h2 class="text-2xl font-bold mb-2 text-gray-300">Your Cinemas</h2>
            <div id="cinemaList" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Cinema Cards Injected Here -->
            </div>
            <div id="emptyState" class="hidden text-center text-gray-500 mt-10">
                <i class="fas fa-film text-6xl mb-4 opacity-30"></i>
                <p>No cinemas found. Create one to get started!</p>
            </div>
        </div>

        <!-- CINEMA VIEW -->
        <div id="cinemaView" class="hidden flex flex-col h-full">

            <!-- Toolbar (Groups) -->
            <div class="bg-gray-800 p-2 rounded-lg shadow-lg mb-4 flex flex-col gap-2 shrink-0">
                <div class="flex justify-between items-center px-1">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Reservation Groups</span>
                    <button onclick="openGroupModal()"
                        class="text-xs text-blue-400 hover:text-blue-300 font-bold px-2 py-1 bg-blue-400/10 rounded">
                        <i class="fas fa-plus"></i> NEW GROUP
                    </button>
                </div>

                <div class="flex gap-2 overflow-x-auto group-scroll pb-2" id="groupToolbar">
                    <!-- Tool: Eraser -->
                    <button onclick="selectTool('eraser')" id="tool-eraser"
                        class="flex items-center gap-2 px-3 py-2 rounded-lg border-2 border-gray-600 bg-gray-700/50 hover:bg-gray-700 transition shrink-0 group-tool ring-2 ring-white">
                        <i class="fas fa-eraser text-gray-400"></i>
                        <div class="flex flex-col items-start leading-none">
                            <span class="text-sm font-bold">Clear</span>
                            <span class="text-[10px] text-gray-500">Available</span>
                        </div>
                    </button>
                    <!-- Groups injected here -->
                </div>
            </div>

            <!-- Grid Container -->
            <div class="flex-grow overflow-auto bg-gray-900/50 rounded-lg p-4 border border-gray-800 relative">
                <div class="cinema-screen"></div>
                <div class="flex justify-center min-w-max">
                    <div id="seatGrid" class="grid gap-2 mb-8">
                        <!-- Seats injected here -->
                    </div>
                </div>
            </div>
            <!-- Legend / Info -->
            <div class="mt-2 text-center text-xs text-gray-500">
                <p>Select a group above, then tap seats to assign.</p>
            </div>
        </div>

    </main>

    <!-- Create Cinema Modal -->
    <div id="createCinemaModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeModal('createCinemaModal')"></div>
        <div class="relative bg-gray-800 w-full max-w-sm rounded-xl shadow-2xl p-6 transform transition-all scale-95">
            <h3 class="text-xl font-bold mb-4">Create New Cinema</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase text-gray-400 font-bold mb-1">Cinema Name</label>
                    <input type="text" id="newCinemaName"
                        class="w-full bg-gray-700 rounded p-2 focus:ring-2 focus:ring-red-500 outline-none"
                        placeholder="e.g. Hall 1">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase text-gray-400 font-bold mb-1">Rows</label>
                        <input type="number" id="newCinemaRows"
                            class="w-full bg-gray-700 rounded p-2 focus:ring-2 focus:ring-red-500 outline-none"
                            value="6" min="1" max="20">
                    </div>
                    <div>
                        <label class="block text-xs uppercase text-gray-400 font-bold mb-1">Columns</label>
                        <input type="number" id="newCinemaCols"
                            class="w-full bg-gray-700 rounded p-2 focus:ring-2 focus:ring-red-500 outline-none"
                            value="8" min="1" max="20">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeModal('createCinemaModal')"
                    class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button onclick="submitNewCinema()"
                    class="px-6 py-2 bg-red-600 rounded-lg hover:bg-red-700 font-bold">Create</button>
            </div>
        </div>
    </div>

    <!-- Rename Cinema Modal -->
    <div id="renameCinemaModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeModal('renameCinemaModal')"></div>
        <div class="relative bg-gray-800 w-full max-w-sm rounded-xl shadow-2xl p-6 transform transition-all scale-95">
            <h3 class="text-xl font-bold mb-4">Rename Cinema</h3>
            <div class="space-y-4">
                <input type="hidden" id="renameCinemaId">
                <div>
                    <label class="block text-xs uppercase text-gray-400 font-bold mb-1">New Name</label>
                    <input type="text" id="renameCinemaName"
                        class="w-full bg-gray-700 rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Cinema Name">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeModal('renameCinemaModal')"
                    class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button onclick="submitRename()"
                    class="px-6 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 font-bold">Save</button>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeModal('createGroupModal')"></div>
        <div class="relative bg-gray-800 w-full max-w-sm rounded-xl shadow-2xl p-6 transform transition-all scale-95">
            <h3 class="text-xl font-bold mb-4">New Reservation Group</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase text-gray-400 font-bold mb-1">Group Name</label>
                    <input type="text" id="newGroupName"
                        class="w-full bg-gray-700 rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="e.g. VIP, Students">
                </div>
                <div>
                    <label class="block text-xs uppercase text-gray-400 font-bold mb-1">Color</label>
                    <div class="flex gap-2 flex-wrap">
                        <!-- Color Pickers -->
                        <button onclick="selectColor('#ef4444')"
                            class="w-8 h-8 rounded-full bg-red-500 ring-2 ring-transparent hover:ring-white color-opt"
                            data-color="#ef4444"></button>
                        <button onclick="selectColor('#f97316')"
                            class="w-8 h-8 rounded-full bg-orange-500 ring-2 ring-transparent hover:ring-white color-opt"
                            data-color="#f97316"></button>
                        <button onclick="selectColor('#eab308')"
                            class="w-8 h-8 rounded-full bg-yellow-500 ring-2 ring-transparent hover:ring-white color-opt"
                            data-color="#eab308"></button>
                        <button onclick="selectColor('#22c55e')"
                            class="w-8 h-8 rounded-full bg-green-500 ring-2 ring-transparent hover:ring-white color-opt"
                            data-color="#22c55e"></button>
                        <button onclick="selectColor('#3b82f6')"
                            class="w-8 h-8 rounded-full bg-blue-500 ring-2 ring-transparent hover:ring-white color-opt"
                            data-color="#3b82f6"></button>
                        <button onclick="selectColor('#a855f7')"
                            class="w-8 h-8 rounded-full bg-purple-500 ring-2 ring-transparent hover:ring-white color-opt"
                            data-color="#a855f7"></button>
                        <button onclick="selectColor('#ec4899')"
                            class="w-8 h-8 rounded-full bg-pink-500 ring-2 ring-transparent hover:ring-white color-opt"
                            data-color="#ec4899"></button>
                        <input type="color" id="customColor" class="w-8 h-8 rounded overflow-hidden"
                            onchange="selectColor(this.value)">
                    </div>
                    <input type="hidden" id="selectedColorInput" value="#3b82f6">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeModal('createGroupModal')"
                    class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button onclick="submitNewGroup()"
                    class="px-6 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 font-bold">Add Group</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <div
            class="relative bg-gray-800 w-full max-w-sm rounded-xl shadow-2xl p-6 transform transition-all scale-95 text-center">
            <i class="fas fa-file-import text-4xl text-blue-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Import Cinema?</h3>
            <p class="text-gray-400 mb-6 text-sm">You are loading a shared cinema layout: <br><span id="importName"
                    class="text-white font-bold"></span></p>
            <div class="flex justify-center gap-3">
                <button
                    onclick="window.history.replaceState({}, document.title, window.location.pathname); closeModal('importModal');"
                    class="px-4 py-2 text-gray-400 hover:text-white">Ignore</button>
                <button onclick="confirmImport()"
                    class="px-6 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 font-bold">Import</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 border-l-4 border-green-500 text-white px-6 py-3 rounded shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-3">
        <i class="fas fa-check-circle text-green-500"></i>
        <span id="toastMsg">Link copied to clipboard!</span>
    </div>

    <script>
        /**
         * Schema Reference:
         * Cinema: { id: string, name: string, rows: number, cols: number, groups: Group[], seats: Seat[] }
         * Group: { id: string, name: string, color: string }
         * Seat: { row: number, col: number, status: 'available'|'reserved', groupId: string|null, guestName: string }
         */

        const STORAGE_KEY = 'cinemaMgr_v2';
        const OLD_STORAGE_KEY = 'cinemaSeats_v1';

        // --- State ---
        let cinemas = [];
        let currentCinemaId = null;
        let pendedImport = null; // Stores cinema data waiting to be imported
        let currentTool = 'eraser'; // 'eraser' or groupId

        // --- DOM Elements ---
        const views = {
            dashboard: document.getElementById('dashboardView'),
            cinema: document.getElementById('cinemaView')
        };
        const elements = {
            backBtn: document.getElementById('backBtn'),
            shareBtn: document.getElementById('shareBtn'),
            createCinemaBtn: document.getElementById('createCinemaBtn'),
            appTitle: document.getElementById('appTitle'),
            cinemaList: document.getElementById('cinemaList'),
            emptyState: document.getElementById('emptyState'),
            seatGrid: document.getElementById('seatGrid'),
            groupToolbar: document.getElementById('groupToolbar'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toastMsg')
        };

        // --- Init ---
        function init() {
            loadData();

            // Check for migration
            const oldData = localStorage.getItem(OLD_STORAGE_KEY);
            if (oldData && cinemas.length === 0) {
                migrateOldData(oldData);
            }

            // Check URL
            const urlParams = new URLSearchParams(window.location.search);
            const shareData = urlParams.get('data');
            if (shareData) {
                try {
                    const json = JSON.parse(decodeURIComponent(escape(atob(shareData))));
                    pendedImport = json;
                    // Show Import Modal
                    document.getElementById('importName').innerText = pendedImport.name || "Shared Cinema";
                    openModal('importModal');
                } catch (e) {
                    console.error("Import failed", e);
                    showToast("Invalid share link", true);
                }
            }

            render();
        }

        function loadData() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                try {
                    cinemas = JSON.parse(raw);
                } catch (e) {
                    cinemas = [];
                }
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cinemas));
        }

        function migrateOldData(jsonStr) {
            try {
                const oldSeats = JSON.parse(jsonStr);
                // Assume 6x8 from v1
                const newCinema = {
                    id: crypto.randomUUID(),
                    name: "Legacy Cinema",
                    rows: 6,
                    cols: 8,
                    groups: [{ id: 'g_default', name: 'Standard', color: '#ef4444' }],
                    seats: oldSeats.map(s => ({
                        row: s.row,
                        col: s.col,
                        status: s.status,
                        groupId: s.status === 'reserved' ? 'g_default' : null,
                        guestName: s.guestName
                    }))
                };
                cinemas.push(newCinema);
                saveData();
                localStorage.removeItem(OLD_STORAGE_KEY); // Cleanup
            } catch (e) {
                console.error("Migration failed", e);
            }
        }

        function confirmImport() {
            if (pendedImport) {
                // Regenerate ID to avoid conflicts if importing same cinema multiple times
                pendedImport.id = crypto.randomUUID();
                pendedImport.name = pendedImport.name + " (Imported)";
                cinemas.push(pendedImport);
                saveData();
                closeModal('importModal');
                window.history.replaceState({}, document.title, window.location.pathname);
                showToast("Cinema Imported Successfully");
                render();
            }
        }

        // --- Navigation ---
        function navigateTo(viewName) {
            if (viewName === 'dashboard') {
                views.dashboard.classList.remove('hidden');
                views.cinema.classList.add('hidden');
                elements.backBtn.classList.add('hidden');
                elements.shareBtn.classList.add('hidden');
                elements.createCinemaBtn.classList.remove('hidden');
                elements.appTitle.innerHTML = `<i class="fas fa-film text-red-500"></i><span>Cinema<span class="text-red-500">Mgr</span></span>`;
                currentCinemaId = null;
            } else if (viewName === 'cinema') {
                views.dashboard.classList.add('hidden');
                views.cinema.classList.remove('hidden');
                views.cinema.classList.add('flex'); // restore flex
                elements.backBtn.classList.remove('hidden');
                elements.shareBtn.classList.remove('hidden');
                elements.createCinemaBtn.classList.add('hidden');

                const c = getCurrentCinema();
                elements.appTitle.innerText = c.name;
            }
        }

        elements.backBtn.onclick = () => {
            currentCinemaId = null;
            render();
        };

        // --- Rendering ---
        function render() {
            if (currentCinemaId) {
                navigateTo('cinema');
                renderCinemaView();
            } else {
                navigateTo('dashboard');
                renderDashboard();
            }
        }

        function renderDashboard() {
            elements.cinemaList.innerHTML = '';
            if (cinemas.length === 0) {
                elements.emptyState.classList.remove('hidden');
                return;
            }
            elements.emptyState.classList.add('hidden');

            cinemas.forEach(c => {
                const reservedCount = c.seats.filter(s => s.status === 'reserved').length;
                const totalSeats = c.rows * c.cols;

                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-4 rounded-xl shadow-md hover:ring-2 hover:ring-red-500 transition cursor-pointer relative group';
                card.innerHTML = `
                    <h3 class="font-bold text-lg mb-1">${c.name}</h3>
                    <p class="text-gray-400 text-xs mb-3 flex items-center gap-2">
                        <span><i class="fas fa-th"></i> ${c.rows}x${c.cols}</span>
                        <span>&bull;</span>
                        <span><i class="fas fa-users"></i> ${c.groups.length} Groups</span>
                    </p>
                    <div class="h-2 w-full bg-gray-700 rounded-full overflow-hidden mb-1">
                        <div class="h-full bg-gradient-to-r from-red-500 to-orange-500" style="width: ${(reservedCount / totalSeats) * 100}%"></div>
                    </div>
                    <p class="text-[10px] text-gray-500 text-right">${reservedCount} / ${totalSeats} reserved</p>
                    
                <div class="flex justify-end gap-3 mt-4 border-t border-gray-700 pt-3">
                    <button onclick="openRenameModal(event, '${c.id}', '${c.name.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-white p-2" title="Rename">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="duplicateCinema(event, '${c.id}')" class="text-gray-400 hover:text-white p-2" title="Duplicate">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button onclick="deleteCinema(event, '${c.id}')" class="text-gray-400 hover:text-red-500 p-2" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                `;
                card.onclick = (e) => {
                    // Prevent click if clicking actions
                    if (e.target.closest('button')) return;
                    currentCinemaId = c.id;
                    render();
                };
                elements.cinemaList.appendChild(card);
            });
        }

        // --- Logic: Rename and Duplicate ---
        function openRenameModal(event, id, currentName) {
            event.stopPropagation();
            document.getElementById('renameCinemaId').value = id;
            document.getElementById('renameCinemaName').value = currentName;
            openModal('renameCinemaModal');
        }

        function submitRename() {
            const id = document.getElementById('renameCinemaId').value;
            const newName = document.getElementById('renameCinemaName').value.trim();

            if (newName) {
                const cinema = cinemas.find(c => c.id === id);
                if (cinema) {
                    cinema.name = newName;
                    saveData();
                    render();
                    closeModal('renameCinemaModal');
                    showToast("Cinema renamed");
                }
            }
        }

        function duplicateCinema(event, id) {
            event.stopPropagation();
            const original = cinemas.find(c => c.id === id);
            if (original) {
                // Deep copy
                const copy = JSON.parse(JSON.stringify(original));
                copy.id = crypto.randomUUID();
                copy.name = original.name + " (Copy)";
                // Regenerate group IDs to avoid linking them? 
                // Actually, if we deep copy, the group IDs are cloned. 
                // If we want them independent, we should regenerate.
                // But seats reference group IDs. So if we regen group IDs, we must update seats.

                // Let's regen group IDs for cleanliness so they are truly independent entities.
                const groupIdMap = {};
                copy.groups.forEach(g => {
                    const oldId = g.id;
                    const newId = crypto.randomUUID();
                    groupIdMap[oldId] = newId;
                    g.id = newId;
                });

                // Update seats
                copy.seats.forEach(s => {
                    if (s.groupId && groupIdMap[s.groupId]) {
                        s.groupId = groupIdMap[s.groupId];
                    }
                });

                cinemas.push(copy);
                saveData();
                render();
                showToast("Cinema duplicated");
            }
        }

        function renderCinemaView() {
            const c = getCurrentCinema();
            if (!c) return; // Error handling

            // 1. Render Toolbar
            // Clear existing non-eraser buttons
            const tools = elements.groupToolbar.querySelectorAll('button:not(#tool-eraser)');
            tools.forEach(t => t.remove());

            // Helper to create tool button
            c.groups.forEach(g => {
                const count = c.seats.filter(s => s.groupId === g.id && s.status === 'reserved').length;
                const btn = document.createElement('button');
                btn.className = `flex items-center gap-2 px-3 py-2 rounded-lg border-2 border-gray-600 bg-gray-700/50 hover:bg-gray-700 transition shrink-0 group-tool min-w-[100px] justify-between ${currentTool === g.id ? 'ring-2 ring-white border-transparent' : 'opacity-70 hover:opacity-100'}`;
                // Set color of border/indicator based on group color
                btn.style.borderColor = currentTool === g.id ? 'white' : g.color;

                btn.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full shadow-sm" style="background-color: ${g.color}"></div>
                        <div class="flex flex-col items-start leading-none">
                            <span class="text-sm font-bold truncate max-w-[80px]">${g.name}</span>
                            <span class="text-[10px] text-gray-400">Reserved</span>
                        </div>
                    </div>
                    <span class="text-xs font-mono bg-gray-900 px-1.5 py-0.5 rounded text-gray-300 ml-2">${count}</span>
                `;
                btn.onclick = () => selectTool(g.id);
                elements.groupToolbar.appendChild(btn);
            });

            // Update Eraser styling
            const eraserBtn = document.getElementById('tool-eraser');
            if (currentTool === 'eraser') {
                eraserBtn.classList.add('ring-2', 'ring-white', 'opacity-100');
                eraserBtn.classList.remove('opacity-70');
            } else {
                eraserBtn.classList.remove('ring-2', 'ring-white', 'opacity-100');
                eraserBtn.classList.add('opacity-70');
            }


            // 2. Render Grid
            elements.seatGrid.innerHTML = '';
            // Set dynamic columns
            elements.seatGrid.style.gridTemplateColumns = `repeat(${c.cols}, minmax(0, 1fr))`;

            c.seats.forEach((seat, idx) => {
                const btn = document.createElement('button');
                // Basic styles
                let classes = "w-8 h-8 sm:w-10 sm:h-10 rounded md:rounded-lg flex items-center justify-center text-sm transition transform active:scale-90 focus:outline-none ";

                if (seat.status === 'available') {
                    classes += "bg-gray-700 text-gray-500 hover:bg-gray-600 hover:text-gray-300";
                    btn.innerHTML = `<i class="fas fa-couch"></i>`;
                } else {
                    // Reserved
                    const group = c.groups.find(g => g.id === seat.groupId);
                    const color = group ? group.color : '#ef4444'; // fallback
                    // We need to apply this color dynamically
                    btn.style.backgroundColor = `${color}33`; // 20% opacity using hex alpha
                    btn.style.color = color;
                    btn.style.border = `1px solid ${color}88`;
                    btn.innerHTML = `<i class="fas fa-couch"></i>`;
                }

                btn.className = classes;
                btn.onclick = () => handleSeatInteract(idx);
                elements.seatGrid.appendChild(btn);
            });
        }

        // --- Logic: Tools & Interaction ---
        function selectTool(toolId) {
            currentTool = toolId;
            renderCinemaView(); // Re-render toolbar to update active state
        }

        function handleSeatInteract(index) {
            const c = getCurrentCinema();
            const seat = c.seats[index];

            if (currentTool === 'eraser') {
                if (seat.status !== 'available') {
                    seat.status = 'available';
                    seat.groupId = null;
                    seat.guestName = '';
                    saveData();
                    renderCinemaView();
                }
            } else {
                // Must be a valid group ID
                const group = c.groups.find(g => g.id === currentTool);
                if (!group) return;

                // If already reserved by this group, do nothing? Or maybe toggle?
                // UX: Painting is usually additive. 
                // If it's different, overwrite. If same, do nothing.
                if (seat.status === 'available' || seat.groupId !== currentTool) {
                    seat.status = 'reserved';
                    seat.groupId = currentTool;
                    saveData();
                    renderCinemaView();
                }
            }
        }

        // --- Logic: Create Cinema ---
        elements.createCinemaBtn.onclick = () => openModal('createCinemaModal');

        function submitNewCinema() {
            const name = document.getElementById('newCinemaName').value.trim() || 'New Cinema';
            let rows = parseInt(document.getElementById('newCinemaRows').value) || 6;
            let cols = parseInt(document.getElementById('newCinemaCols').value) || 8;

            // Generate seats
            const seats = [];
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    seats.push({ row: r, col: c, status: 'available', groupId: null, guestName: '' });
                }
            }

            const newCinema = {
                id: crypto.randomUUID(),
                name: name,
                rows: rows,
                cols: cols,
                groups: [
                    { id: crypto.randomUUID(), name: 'General', color: '#ef4444' } // Default group
                ],
                seats: seats
            };

            cinemas.push(newCinema);
            saveData();
            closeModal('createCinemaModal');

            // Reset input
            document.getElementById('newCinemaName').value = '';

            // Go to it
            currentCinemaId = newCinema.id;
            currentTool = newCinema.groups[0].id; // Select default group
            render();
        }

        function deleteCinema(event, id) {
            event.stopPropagation();
            if (confirm("Are you sure you want to delete this cinema? This cannot be undone.")) {
                cinemas = cinemas.filter(c => c.id !== id);
                saveData();
                render();
            }
        }

        // --- Logic: Create Group ---
        function openGroupModal() {
            openModal('createGroupModal');
            // Select first color by default
            selectColor('#3b82f6');
        }

        function submitNewGroup() {
            const c = getCurrentCinema();
            if (!c) return;

            const name = document.getElementById('newGroupName').value.trim() || 'Group ' + (c.groups.length + 1);
            const color = document.getElementById('selectedColorInput').value;

            const newGroup = {
                id: crypto.randomUUID(),
                name: name,
                color: color
            };

            c.groups.push(newGroup);
            saveData();
            closeModal('createGroupModal');
            document.getElementById('newGroupName').value = '';

            // Determine behavior: auto select new group?
            currentTool = newGroup.id;
            renderCinemaView();
        }

        // Color Picker Logic
        function selectColor(color) {
            document.getElementById('selectedColorInput').value = color;
            // Visual Update
            document.querySelectorAll('.color-opt').forEach(btn => {
                if (btn.dataset.color === color) {
                    btn.classList.add('ring-white');
                    btn.classList.remove('ring-transparent');
                } else {
                    btn.classList.remove('ring-white');
                    btn.classList.add('ring-transparent');
                }
            });
            // Also update custom picker if it matches
            const cp = document.getElementById('customColor');
            // If it's a hex from our list, update picker value
            if (color.startsWith('#')) cp.value = color;
        }

        // --- Sharing ---
        elements.shareBtn.onclick = () => {
            const c = getCurrentCinema();
            if (!c) return;

            // Encode current cinema
            const jsonStr = JSON.stringify(c);
            const base64 = btoa(unescape(encodeURIComponent(jsonStr)));

            const url = new URL(window.location.href);
            url.searchParams.set('data', base64);

            const shareUrl = url.toString();

            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast("Cinema link copied!");
            }).catch(e => {
                prompt("Copy link:", shareUrl);
            });
        };

        // --- Helpers ---
        function getCurrentCinema() {
            return cinemas.find(c => c.id === currentCinemaId);
        }

        function openModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('opacity-0', 'pointer-events-none');
            m.querySelector('.transform').classList.remove('scale-95');
            m.querySelector('.transform').classList.add('scale-100');
        }

        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.add('opacity-0', 'pointer-events-none');
            m.querySelector('.transform').classList.remove('scale-100');
            m.querySelector('.transform').classList.add('scale-95');
        }

        function showToast(msg, isError) {
            elements.toastMsg.innerText = msg;
            elements.toast.classList.remove('opacity-0');
            if (isError) elements.toast.firstElementChild.className = "fas fa-exclamation-circle text-red-500";
            else elements.toast.firstElementChild.className = "fas fa-check-circle text-green-500";

            setTimeout(() => {
                elements.toast.classList.add('opacity-0');
            }, 3000);
        }

        // Init
        init();

    </script>
</body>

</html>